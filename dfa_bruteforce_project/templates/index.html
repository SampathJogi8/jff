<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DFA Brute-force Detection (v7)</title>
  <style>
    :root{--bg:#f5f7fb;--card:#ffffff;--accent:#1565c0;--muted:#6b7280;}
    body{font-family:Inter,Segoe UI,Arial; background:var(--bg); margin:0; padding:24px;}
    .container{max-width:1000px; margin:0 auto;}
    .card{background:var(--card); border-radius:12px; padding:20px; box-shadow:0 6px 24px rgba(12,26,40,0.06);}
    header{display:flex; justify-content:space-between; align-items:center;}
    h1{margin:0; font-size:20px; color:var(--accent);}
    .row{display:flex; gap:20px; margin-top:18px;}
    .left{flex:1;}
    .right{flex:1;}
    input, select{width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #e5e7eb;}
    button{background:var(--accent); color:white; padding:10px 14px; border-radius:8px; border:none; cursor:pointer;}
    .message{margin-top:12px; padding:10px; border-radius:8px;}
    .success{background:#e6f4ea; color:#14532d;}
    .fail{background:#fff1f2; color:#7f1d1d;}
    .alert{background:#fff7ed; color:#92400e;}
    .small{color:var(--muted); font-size:13px;}
    .top-actions{display:flex; gap:8px;}
    .stats{display:flex; gap:12px; margin-top:12px;}
    .stat-box{flex:1; background:#fafbff; padding:10px; border-radius:8px; text-align:center;}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>üîê DFA Brute-force Detection</h1>
        <div class="top-actions"><a href="/admin" style="text-decoration:none"><button style="background:#374151">Admin Logs</button></a></div>
      </header>
      <div class="row">
        <div class="left">
          <h3>Login</h3>
          <form method="POST" action="/login">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
          </form>
          {% if result %}
            <div class="message {{ css_class }}">{{ result }}<br><small class="small"><b>State:</b> {{ state }}</small></div>
          {% endif %}
          <hr>
        </div>
        <div class="right">
          <h3>Analytics</h3>
          <p class="small">Filter by username to view per-user DFA transitions:</p>
          <select id="usernameSelect" onchange="updateChart()">
            <option value="">-- All users --</option>
            <option value="admin">admin</option>
            <option value="user1">user1</option>
          </select>
          <div class="stats">
            <div class="stat-box"><div class="small">Total Attempts</div><div id="total">-</div></div>
            <div class="stat-box"><div class="small">Successes</div><div id="succ">-</div></div>
            <div class="stat-box"><div class="small">Failures</div><div id="fail">-</div></div>
          </div>
          <div style="margin-top:12px;"><img id="chart" src="/stats.png" style="max-width:100%; border-radius:8px;"></div>
        </div>
      </div>
    </div>
  </div>
<script>
function updateChart(){
    var sel = document.getElementById('usernameSelect');
    var user = sel.value;
    var img = document.getElementById('chart');
    img.src = '/stats.png' + (user ? ('?username=' + encodeURIComponent(user)) : '' ) + '&_=' + Date.now();
    // fetch simple stats from /admin?username=... by requesting admin page and parsing is heavy; leave static for demo
}
</script>
<script>
function updateChart(){
    var sel = document.getElementById('usernameSelect');
    var user = sel.value;
    var img = document.getElementById('chart');
    img.src = '/stats.png' + (user ? ('?username=' + encodeURIComponent(user)) : '' ) + '&_=' + Date.now();
    fetch('/stats-data' + (user ? ('?username=' + encodeURIComponent(user)) : '' ))
      .then(res => res.json())
      .then(data => {
          document.getElementById('total').innerText = data.total;
          document.getElementById('succ').innerText = data.succ;
          document.getElementById('fail').innerText = data.fail;
      });
}
// run once and auto-refresh every 10s
updateChart();
setInterval(updateChart, 10000);
</script>

</body>
</html>
